let is_iOS = (() => {
  return [
    'iPad Simulator',
    'iPhone Simulator',
    'iPod Simulator',
    'iPad',
    'iPhone',
    'iPod'
  ].includes(navigator.platform)
  // iPad on iOS 13 detection
  || (navigator.userAgent.includes("Mac") && "ontouchend" in document)
})()


function PopUpShow() {
  document.getElementById('popup1').style.display = "flex";
  document.getElementById('nameForm').value = "Форма - заказать обратный звонок";
  document.getElementById('popup_content_name').innerHTML = "Заявка на обратный звонок";
  document.getElementById('popup_content_name').style.width="100%";
    document.getElementById('telpopup').focus();
  $('button[type="submit"]').removeAttr('disabled')
}
function PopUpShowMobile() {
  document.getElementById('popup1').style.display = "flex";
  document.getElementById('nameForm').value = "Форма - отавить заявку (на мобильных)";
  document.getElementById('popup_content_name').innerHTML = "Заявка на обратный звонок";
  document.getElementById('popup_content_name').style.width="100%";
    document.getElementById('telpopup').focus();
  $('button[type="submit"]').removeAttr('disabled')
}
function PopUpShowTestDrive() {
  document.getElementById('popup1').style.display = "flex";
  document.getElementById('nameForm').value = "Форма - тест-драйв";
  document.getElementById('popup_content_name').innerHTML = "Тест-драйв OMODA&nbsp;С5";
  document.getElementById('popup_content_name').style.width="100%";
    document.getElementById('telpopup').focus();
  $('button[type="submit"]').removeAttr('disabled')
}
function PopUpShowService() {
  document.getElementById('popup1').style.display = "flex";
  document.getElementById('nameForm').value = "Форма - сервис OMODA&nbsp;С5";
  document.getElementById('popup_content_name').innerHTML = "Сервис OMODA&nbsp;С5";
  document.getElementById('popup_content_name').style.width="100%";
    document.getElementById('telpopup').focus();
  $('button[type="submit"]').removeAttr('disabled')
}
function PopUpShowOtdel() {
  document.getElementById('popup1').style.display = "flex";
  document.getElementById('nameForm').value = "Форма - Отдел продаж OMODA&nbsp;С5";
  document.getElementById('popup_content_name').innerHTML = "Отдел продаж OMODA&nbsp;С5";
  document.getElementById('popup_content_name').style.width="100%";
    document.getElementById('telpopup').focus();
  $('button[type="submit"]').removeAttr('disabled')
}
function PopUpShowService() {
  document.getElementById('popup1').style.display = "flex";
  document.getElementById('nameForm').value = "Форма - Сервисный центр OMODA&nbsp;С5";
  document.getElementById('popup_content_name').innerHTML = "Сервисный центр OMODA&nbsp;С5";
  document.getElementById('popup_content_name').style.width="100%";
    document.getElementById('telpopup').focus();
  $('button[type="submit"]').removeAttr('disabled')
}
function PopUpShowConfig() {
  document.getElementById('popup1').style.display = "flex";
  document.getElementById('nameForm').value = "Форма - Подбор конфигурации OMODA&nbsp;С5";
  document.getElementById('popup_content_name').innerHTML = "Подбор конфигурации OMODA&nbsp;С5";
  document.getElementById('popup_content_name').style.width="100%";
    document.getElementById('telpopup').focus();
  $('button[type="submit"]').removeAttr('disabled')
}

function PopUpShowPred() {
  document.getElementById('popup1').style.display = "flex";
  document.getElementById('nameForm').value = "Форма - Получить спецпредложение";
  document.getElementById('popup_content_name').innerHTML = "Получить спецпредложение";
  document.getElementById('popup_content_name').style.width="100%";
    document.getElementById('telpopup').focus();
    $('button[type="submit"]').removeAttr('disabled')
}


function showCarPopup(title, title2 = '') {
  document.getElementById('popup1').style.display = "flex";
  document.getElementById('nameForm').value = `Форма - ${title} ${title2}`;
  document.getElementById('popup_content_name').innerHTML = `${title} \r\n ${title2}`;
  document.getElementById('popup_content_name').style.width="100%";
  document.getElementById('telpopup').focus();
  $('button[type="submit"]').removeAttr('disabled')
}

function PopUpHide() {
  document.getElementById('popup1').style.display = "none";
}

function PopUpShow2() {
  $("#popupThanks").css('display', 'flex');
}

function PopUpHide2() {
  $("#popupThanks").hide();
}


$('.change_color a').click(function(e) {
  e.preventDefault();
  $targetImgEl = $(this).closest('.block2_content_card_left').find('.car_img');
  $newSrc = $(this).attr('href');
  $targetImgEl.attr('src', $newSrc);
  $(this).siblings('a').removeClass('active')
  $(this).addClass('active')
})

$('.change_color').each(function() { // активируем первый кружок
  $(this).find('a').removeClass('active')
  $(this).find('a').eq(0).addClass('active')
})

$(function() {

  $('.main-block-slider').slick({
    slidesToShow: 1,
    slidesToScroll: 1,
    arrows: false,
    dots: true,
    autoplay: true,
    autoplaySpeed: 3000,
  })

  // Слайдер "Подобрать комплектацию"
  const $selConfSlick = $('.sel-conf__items').slick({
    slidesToShow: 1,
    slidesToScroll: 1,
    arrows: false,
    dots: false,

  })
  $selConfSlick.on('afterChange', function(event, slick, currentSlide){
    $('.sel-conf__nav > li').removeClass('active')
    $('.sel-conf__nav > li').eq(currentSlide).addClass('active')
  });
  $('.sel-conf__nav > li').on('click', function() {
    $selConfSlick.slick('slickGoTo', $(this).index())
    $(this).siblings().removeClass('active')
    $(this).addClass('active')
  })

  $('[data-counter]').counter({
    thousandsSep: '',
   });

  // Кнопка "Подобрать комплектацию"
  $('.sel-conf-item__send-btn').on('click', function() {
    const $confItem = $(this).closest('.sel-conf-item')
    const confName = $confItem.find('[name="conf_name"]').val()
    showCarPopup('Выбрать комплектацию ', confName)
  })

  // Advantages
  const $advantagesSlick = $('.advantages__items').slick({
    slidesToShow: 1,
    slidesToScroll: 1,
    arrows: false,
    dots: false,
    fade: true,
    adaptiveHeight: true
  })
  const $advantagesHeadersSlick = $('.advantages__headers').slick({
    slidesToShow: 1,
    slidesToScroll: 1,
    arrows: false,
    dots: false,
    fade: true,
    responsive: [
      {
        breakpoint: 767,
        settings: {
          adaptiveHeight: true
        }
      }
    ]
  })
    $('.advantages__nav > li').on('click', function() {
    $advantagesSlick.slick('slickGoTo', $(this).index())
    $advantagesHeadersSlick.slick('slickGoTo', $(this).index())
    $(this).siblings().removeClass('active')
    $(this).addClass('active')
  })
  $advantagesSlick.on('afterChange', function(event, slick, currentSlide){
    $('.advantages__nav > li').removeClass('active')
    $('.advantages__nav > li').eq(currentSlide).addClass('active')
    $advantagesHeadersSlick.slick('slickGoTo', currentSlide)
  });
  $advantagesHeadersSlick.on('afterChange', function(event, slick, currentSlide){
    $('.advantages__nav > li').removeClass('active')
    $('.advantages__nav > li').eq(currentSlide).addClass('active')
    $advantagesSlick.slick('slickGoTo', currentSlide)
  });


  // Card info collapse
  $('.block2_info_car').on('click', function(e) {
    const $cardInfo = $(this).closest('.block2_info_car')
    const isCollapsed = !$cardInfo.hasClass('open')
    const el = $cardInfo.get(0)
    $cardInfo.toggleClass('open')
    if (isCollapsed) {
      el.style.height = 'auto'
      const fullHeight = el.offsetHeight + 'px'
      el.style.removeProperty('height')
      el.offsetHeight
      el.style.height = fullHeight
    } else {
      el.style.removeProperty('height')
    }
  })
  
  // Улучшенная валидация телефона
  $('input[type="tel"]').on('input', function(e) {
    const phone = this.value.replace(/[^\d]/g, '');
    let isValid = true;
    
    if (this.validity.patternMismatch && isValid) {
      this.setCustomValidity('Укажите номер в формате мобильного оператора РФ');
      isValid = false;
    } 
    // Дополнительная проверка кода оператора
    else if (phone.length >= 2) {
      const operatorCode = phone.charAt(1);
      if (operatorCode !== '8' && operatorCode !== '9') {
        this.setCustomValidity('Код оператора должен начинаться с 8 или 9');
        isValid = false;
      } else {
        this.setCustomValidity('');
        isValid = true;
      }
    } else {
      this.setCustomValidity('');
      isValid = true;
    }
  });

  // Валидация при потере фокуса
  $('input[type="tel"]').on('blur', function() {
    const phone = this.value.replace(/[^\d]/g, '');
    
    if (phone.length > 0 && phone.length < 11) {
      this.setCustomValidity('Номер должен содержать 11 цифр');
    } else if (phone.length === 11) {
      const operatorCode = phone.charAt(1);
      if (operatorCode !== '8' && operatorCode !== '9') {
        this.setCustomValidity('Код оператора должен начинаться с 8 или 9');
      } else {
        this.setCustomValidity('');
      }
    }
  });

  // Дополнительная валидация при отправке формы
  $('form').on('submit', function(e) {
    const telInputs = $(this).find('input[type="tel"]');
    
    telInputs.each(function() {
      const phone = this.value.replace(/[^\d]/g, '');
      
      // Проверяем что номер начинается с 7 и второй символ 8 или 9
      if (phone.length === 11 && phone.startsWith('7')) {
        const operatorCode = phone.charAt(1);
        if (operatorCode !== '8' && operatorCode !== '9') {
          e.preventDefault();
          this.setCustomValidity('Укажите номер с корректным кодом оператора (8** или 9**)');
          this.reportValidity();
          return false;
        } else {
          this.setCustomValidity('');
        }
      } else if (phone.length > 0) {
        e.preventDefault();
        this.setCustomValidity('Укажите корректный номер телефона');
        this.reportValidity();
        return false;
      }
    });
  });
})


window.addEventListener('resize', function() {
  document.documentElement.style.setProperty('--vh', `${window.innerHeight}px`);
})
// setInterval(function() {
//   document.getElementById('test').innerHTML = window.innerHeight
// }, 1000)

if (is_iOS) {
  $('body').addClass('is_iOS');
}