let is_iOS = (() => {
  return [
    'iPad Simulator',
    'iPhone Simulator',
    'iPod Simulator',
    'iPad',
    'iPhone',
    'iPod'
  ].includes(navigator.platform)
  // iPad on iOS 13 detection
  || (navigator.userAgent.includes("Mac") && "ontouchend" in document)
})()

// Переменная для отслеживания отправки заявки в текущем сеансе
let formSubmittedThisSession = false;

// Функция валидации телефонного номера
function validatePhoneNumber(input) {
  const phone = input.value.replace(/[^\d]/g, '');
  
  // Если номер пустой, сбрасываем ошибку
  if (phone.length === 0) {
    input.setCustomValidity('');
    return true;
  }
  
  // Проверяем длину номера (должно быть ровно 11 цифр)
  if (phone.length !== 11) {
    input.setCustomValidity('Номер должен содержать 11 цифр');
    return false;
  }
  
  // Проверяем что номер начинается с 7
  if (!phone.startsWith('7')) {
    input.setCustomValidity('Номер должен начинаться с +7');
    return false;
  }
  
  // Проверяем код оператора (вторая цифра должна быть 8 или 9)
  const operatorCode = phone.charAt(1);
  if (operatorCode !== '8' && operatorCode !== '9') {
    input.setCustomValidity('Код оператора должен начинаться с 8 или 9');
    return false;
  }
  
  // Если все проверки пройдены
  input.setCustomValidity('');
  return true;
}

// Функция показа сообщения об ограничении
function showSessionLimitMessage() {
  document.getElementById('popup_content_name').innerHTML = "Заявка уже отправлена";
  document.getElementById('popupThanks').querySelector('.popup_content_tittle').innerHTML = "Вы уже отправили заявку в этом сеансе. Обновите страницу для повторной отправки или дождитесь звонка менеджера.";
  $("#popupThanks").css('display', 'flex');
}

function PopUpShow() {
  if (formSubmittedThisSession) {
    showSessionLimitMessage();
    return;
  }
  document.getElementById('popup1').style.display = "flex";
  document.getElementById('nameForm').value = "Форма - заказать обратный звонок";
  document.getElementById('popup_content_name').innerHTML = "Заявка на обратный звонок";
  document.getElementById('popup_content_name').style.width="100%";
    document.getElementById('telpopup').focus();
  $('button[type="submit"]').removeAttr('disabled')
}
function PopUpShowMobile() {
  if (formSubmittedThisSession) {
    showSessionLimitMessage();
    return;
  }
  document.getElementById('popup1').style.display = "flex";
  document.getElementById('nameForm').value = "Форма - отавить заявку (на мобильных)";
  document.getElementById('popup_content_name').innerHTML = "Заявка на обратный звонок";
  document.getElementById('popup_content_name').style.width="100%";
    document.getElementById('telpopup').focus();
  $('button[type="submit"]').removeAttr('disabled')
}
function PopUpShowTestDrive() {
  if (formSubmittedThisSession) {
    showSessionLimitMessage();
    return;
  }
  document.getElementById('popup1').style.display = "flex";
  document.getElementById('nameForm').value = "Форма - тест-драйв";
  document.getElementById('popup_content_name').innerHTML = "Тест-драйв KAIYI";
  document.getElementById('popup_content_name').style.width="100%";
    document.getElementById('telpopup').focus();
  $('button[type="submit"]').removeAttr('disabled')
}
function PopUpShowService() {
  if (formSubmittedThisSession) {
    showSessionLimitMessage();
    return;
  }
  document.getElementById('popup1').style.display = "flex";
  document.getElementById('nameForm').value = "Форма - сервис KAIYI";
  document.getElementById('popup_content_name').innerHTML = "Сервис KAIYI";
  document.getElementById('popup_content_name').style.width="100%";
    document.getElementById('telpopup').focus();
  $('button[type="submit"]').removeAttr('disabled')
}
function PopUpShowOtdel() {
  if (formSubmittedThisSession) {
    showSessionLimitMessage();
    return;
  }
  document.getElementById('popup1').style.display = "flex";
  document.getElementById('nameForm').value = "Форма - Отдел продаж KAIYI";
  document.getElementById('popup_content_name').innerHTML = "Отдел продаж KAIYI";
  document.getElementById('popup_content_name').style.width="100%";
    document.getElementById('telpopup').focus();
  $('button[type="submit"]').removeAttr('disabled')
}
function PopUpShowConfig() {
  if (formSubmittedThisSession) {
    showSessionLimitMessage();
    return;
  }
  document.getElementById('popup1').style.display = "flex";
  document.getElementById('nameForm').value = "Форма - Подбор конфигурации KAIYI";
  document.getElementById('popup_content_name').innerHTML = "Подбор конфигурации KAIYI";
  document.getElementById('popup_content_name').style.width="100%";
    document.getElementById('telpopup').focus();
  $('button[type="submit"]').removeAttr('disabled')
}

function PopUpShowPred() {
  if (formSubmittedThisSession) {
    showSessionLimitMessage();
    return;
  }
  document.getElementById('popup1').style.display = "flex";
  document.getElementById('nameForm').value = "Форма - Получить спецпредложение";
  document.getElementById('popup_content_name').innerHTML = "Получить спецпредложение";
  document.getElementById('popup_content_name').style.width="100%";
    document.getElementById('telpopup').focus();
    $('button[type="submit"]').removeAttr('disabled')
}


function showCarPopup(title, title2 = '') {
  if (formSubmittedThisSession) {
    showSessionLimitMessage();
    return;
  }
  document.getElementById('popup1').style.display = "flex";
  document.getElementById('nameForm').value = `Форма - ${title} ${title2}`;
  document.getElementById('popup_content_name').innerHTML = `${title} \r\n ${title2}`;
  document.getElementById('popup_content_name').style.width="100%";
  document.getElementById('telpopup').focus();
  $('button[type="submit"]').removeAttr('disabled')
}

function PopUpHide() {
  document.getElementById('popup1').style.display = "none";
}

function PopUpShow2() {
  $("#popupThanks").css('display', 'flex');
}

function PopUpHide2() {
  $("#popupThanks").hide();
}


$('.change_color a').click(function(e) {
  e.preventDefault();
  $targetImgEl = $(this).closest('.block2_content_card_left').find('.car_img');
  $newSrc = $(this).attr('href');
  $targetImgEl.attr('src', $newSrc);
  $(this).siblings('a').removeClass('active')
  $(this).addClass('active')
})

$('.change_color').each(function() { // активируем первый кружок
  $(this).find('a').removeClass('active')
  $(this).find('a').eq(0).addClass('active')
})

$(function() {

  $('.main-block-slider').slick({
    slidesToShow: 1,
    slidesToScroll: 1,
    arrows: false,
    dots: true,
    autoplay: true,
    autoplaySpeed: 3000,
  })

  // Слайдер "Подобрать комплектацию"
  const $selConfSlick = $('.sel-conf__items').slick({
    slidesToShow: 1,
    slidesToScroll: 1,
    arrows: false,
    dots: false,

  })
  $selConfSlick.on('afterChange', function(event, slick, currentSlide){
    $('.sel-conf__nav > li').removeClass('active')
    $('.sel-conf__nav > li').eq(currentSlide).addClass('active')
  });
  $('.sel-conf__nav > li').on('click', function() {
    $selConfSlick.slick('slickGoTo', $(this).index())
    $(this).siblings().removeClass('active')
    $(this).addClass('active')
  })

  $('[data-counter]').counter({
    thousandsSep: '',
   });

  // Кнопка "Подобрать комплектацию"
  $('.sel-conf-item__send-btn').on('click', function() {
    const $confItem = $(this).closest('.sel-conf-item')
    const confName = $confItem.find('[name="conf_name"]').val()
    showCarPopup('Выбрать комплектацию ', confName)
  })

  // Advantages
  const $advantagesSlick = $('.advantages__items').slick({
    slidesToShow: 1,
    slidesToScroll: 1,
    arrows: false,
    dots: false,
    fade: true,
    adaptiveHeight: true
  })
  const $advantagesHeadersSlick = $('.advantages__headers').slick({
    slidesToShow: 1,
    slidesToScroll: 1,
    arrows: false,
    dots: false,
    fade: true,
    responsive: [
      {
        breakpoint: 767,
        settings: {
          adaptiveHeight: true
        }
      }
    ]
  })
    $('.advantages__nav > li').on('click', function() {
    $advantagesSlick.slick('slickGoTo', $(this).index())
    $advantagesHeadersSlick.slick('slickGoTo', $(this).index())
    $(this).siblings().removeClass('active')
    $(this).addClass('active')
  })
  $advantagesSlick.on('afterChange', function(event, slick, currentSlide){
    $('.advantages__nav > li').removeClass('active')
    $('.advantages__nav > li').eq(currentSlide).addClass('active')
    $advantagesHeadersSlick.slick('slickGoTo', currentSlide)
  });
  $advantagesHeadersSlick.on('afterChange', function(event, slick, currentSlide){
    $('.advantages__nav > li').removeClass('active')
    $('.advantages__nav > li').eq(currentSlide).addClass('active')
    $advantagesSlick.slick('slickGoTo', currentSlide)
  });


  // Card info collapse
  $('.block2_info_car').on('click', function(e) {
    const $cardInfo = $(this).closest('.block2_info_car')
    const isCollapsed = !$cardInfo.hasClass('open')
    const el = $cardInfo.get(0)
    $cardInfo.toggleClass('open')
    if (isCollapsed) {
      el.style.height = 'auto'
      const fullHeight = el.offsetHeight + 'px'
      el.style.removeProperty('height')
      el.offsetHeight
      el.style.height = fullHeight
    } else {
      el.style.removeProperty('height')
    }
  })
  
  // Улучшенная валидация телефона при вводе
  $('input[type="tel"]').on('input', function(e) {
    validatePhoneNumber(this);
  });

  // Валидация при потере фокуса
  $('input[type="tel"]').on('blur', function() {
    validatePhoneNumber(this);
  });

  // Дополнительная валидация при отправке формы
  $('form').on('submit', function(e) {
    // Проверяем, не была ли уже отправлена заявка в этом сеансе
    if (formSubmittedThisSession) {
      e.preventDefault();
      e.stopImmediatePropagation();
      PopUpHide();
      showSessionLimitMessage();
      return false;
    }
    
    const telInputs = $(this).find('input[type="tel"]');
    
    telInputs.each(function() {
      if (!validatePhoneNumber(this)) {
        e.preventDefault();
        this.reportValidity();
        return false;
      }
    });
    
    // Если форма проходит валидацию, помечаем что заявка отправлена
    if (!e.isDefaultPrevented()) {
      formSubmittedThisSession = true;
    }
  });
})


window.addEventListener('resize', function() {
  document.documentElement.style.setProperty('--vh', `${window.innerHeight}px`);
})
// setInterval(function() {
//   document.getElementById('test').innerHTML = window.innerHeight
// }, 1000)

if (is_iOS) {
  $('body').addClass('is_iOS');
}